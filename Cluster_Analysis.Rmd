---
title: '**Identifying heterogeneous subgroups of systemic autoimmune diseases by applying a joint dimension reduction and clustering approach to immunomarkers : a retrospective study** <br/>- cluster analysis'
author: |
  **Chia-Wei Chang^a,#^, Hsin-Yao Wang^b,#^, Wan-Ying Lin^c^, Yu-Chiang Wang^d^, Wei-Lin Lo^e^, Wei-Ting Lin^b^, Jia-Ruei Yu^b^, Yi-Ju Tseng^a,d,\*^** <br/>
  ^a^ Department of Computer Science, National Yang Ming Chiao Tung University, Hsinchu, Taiwan <br/>
  ^b^ Department of Laxboratory Medicine, Chang Gung Memorial Hospital at Linkou, Taoyuan City, Taiwan <br/>
  ^c^ Syu Kang Sport Clinic, Taipei, Taiwan <br/>
  ^d^ d Department of Medicine, Brigham and Women’s Hospital, Boston, USA <br/>
  ^e^ Department of Rheumatology, Chang Gung Memorial Hospital at Keelung, Keelung City, Taiwan <br/>
  ^f^ Computational Health Informatics Program, Boston Children’s Hospital, Boston, MA, USA <br/>
  ^#^ Chang and Wang contribute equally to this work <br/>
  ^\*^ Corresponding Author <br/>
output:
  github_document
---

```{css CSS settings, echo=FALSE,eval=FALSE}
h1.title {
  font-size: 28px;
  /* color: royalblue; */
}

h1 {
  font-size: 28px;
}

h2 {
  font-size: 24px;
}

h3 {
  font-size: 20px;
}

h4 {
  font-size: 16px;
}

<!-- code.r{ /* Code block */ -->
<!--     font-size: 12px; -->
<!-- } -->

<!-- pre { /* Code block - determines code spacing between lines */ -->
<!--     font-size: 14px; -->
<!-- } -->

```

***

# Set up for environment
## Load packages from CRAN
```{r Load packages from CRAN, warning=FALSE, message=FALSE}
.cran_pkgs <- c("data.table",
                "dplyr",
                "magrittr",
                "stringr",
                "lubridate",
                "scales",
                "tidyr",
                
                "purrr",
                "furrr",
                "devtools",
                "knitr",
                
                "modeest",
                "vcd",
                "psych",
                "DescTools",
                "clustrd",
                "yardstick",

                "ggplot2",
                "ggsci",
                "ggrepel",
                "ggforce",
                "ggpubr",
                "cowplot",
                
                "tableone",
                "flextable"
                
                )

if (any(!.cran_pkgs %in% installed.packages())) {
  install.packages(.cran_pkgs[!.cran_pkgs %in% installed.packages()],
                   lib = Sys.getenv("R_LIBS_USER"),
                   dependencies = TRUE)
}

sapply(.cran_pkgs,
       function(x) suppressPackageStartupMessages(require(x,character.only = TRUE)))

```

## Load external functions
```{r External functions}
source("./External_R_Functions/ggRadar2.R")
source("./External_R_Functions/cramer'V matrix.R")
```
<br/>

```{r GitHub packages, warning=FALSE, message=FALSE, eval=FALSE, echo=FALSE}
## Load packages from GitHub
.ghub_pkgs <- c("rstudio/webshot2")

if (any(!sapply(strsplit(.ghub_pkgs,"/"),`[`,2) %in% installed.packages())){
  library(devtools)
  install_github(.ghub_pkgs[!sapply(strsplit(.ghub_pkgs,"/"),`[`,2) %in% installed.packages()],
                 lib = Sys.getenv("R_LIBS_USER"),
                 dependencies = TRUE,
                 force = TRUE)
}

sapply(sapply(strsplit(.ghub_pkgs,"/"),`[`,2),
       function(x) suppressPackageStartupMessages(require(x,character.only = TRUE)))

```

# Import datasets
## Analysis-ready dataset[^*]

From [Data_Wrangling.md](https://github.com/DHLab-TSENG/Heterogeneity-in-SAD-paper/blob/main/Data_Wrangling.md)

```{r SAD dataset}
monoCTD_dataset <- 
  readRDS("./Dataset/A5_monoCTD_ready_analysis_dataset.rds") %>%
  # Subset subjects first diagnosed between 2001 and 2016
  .[data.table::between(year(First_diagnosis_date),lower = 2001,upper = 2016),]

```
<br/>

[^*]: Data availability in this repository is restricted due to the regulation of the law on the protection of patients' data

## Query table for immunomarkers
```{r Query table for immunomarkers}
simul_classify_item <- 
  list(c("72-134","M25-238"),                  # Rheumatoid factor (RF)
       c("72-245","72A245","72B245","72C245"), # Antinuclear antibody (ANA)
       c("72-247","M25-150"))                  # anti-Double strand DNA antibody (anti-dsDNA)

removed_items <- c("ESR","CRP","CRP-Emr")      # Remove CRP, CRP-Emr, and ESR items

exam_table <- 
  fread("./Dataset/exam_table.csv") %>% 
  .[,ITEM_LABSH1IT := paste(ITEM,LABSH1IT,sep = "_")] %>% 
  .[,.SD,.SDcols = c("LABIT","LABSH1IT","ITEM","ITEM_LABSH1IT","LABNMABV")] %>% 
  # Remove redundant items in simultaneously classify items 
  .[!LABSH1IT %in% c(map(simul_classify_item, ~ .x[-1],) %>% flatten_chr(.)),] %>% 
  # Remove CRP, CRP-Emr, and ESR items
  .[str_detect(ITEM,paste(removed_items,collapse = "|"),negate = TRUE),] %>% 
  .[,unique(.SD)]

```
<br/>

***

# Data preparation for feature selection
## Transform datset into wide format by immunomarker
```{r Transform into wide format}
cluster_analysis_data <- 
  copy(monoCTD_dataset) %>% 
   .[,':=' (ITEM     = str_split(ITEM_LABSH1IT,"_",simplify = TRUE)[,1],
            LABSH1IT = str_split(ITEM_LABSH1IT,"_",simplify = TRUE)[,2])] %>% 
   .[str_detect(ITEM,paste(removed_items,collapse = "|"),negate = TRUE),] %>% 
   .[,Group := as.character(Group)] %>%
   .[,.SD,.SDcols = -c("First_diagnosis_date","LABSH1IT","ITEM_LABSH1IT","SCDATE")] %>% 
   .[,AGE := mlv(AGE,method = "mfv"),by = .(IDCODE)] %>% 
   dcast(.,... ~ ITEM,value.var = "Imp_Status",fun.aggregate = toString,fill = "-") %>% 
  ## Substitute complete with abbreviation
   setnames(.,exam_table$ITEM,exam_table$LABNMABV) %>%
  ## Preprocess for MCA-Kmeans
   .[,c(exam_table$LABNMABV) := map(.SD, ~ str_replace_all(.x,c("Normal" = "N_","Abnormal" = "AbN_"))),
     .SDcols = exam_table$LABNMABV] %>%
   .[,c(exam_table$LABNMABV) := map2(.SD,exam_table$LABNMABV, ~ paste0(.x,.y)),
     .SDcols = exam_table$LABNMABV] %>%
   .[,c(exam_table$LABNMABV) := map(.SD, ~ factor(.x)),
     .SDcols = exam_table$LABNMABV]

```
<br/>

## Subset for selected SADs
```{r Subset for selected SADs}
selected_disease_groups <- 
  c("Sjogren's syndrome","Rheumatoid arthritis","Systemic lupus erythematosus")

cluster_analysis_data <- 
  cluster_analysis_data[Group %in% selected_disease_groups,]

```
<br/>

## Remove variables with single unique value (no information or all Normal)
```{r Remove variables without information}
redundant_vars <- 
  copy(cluster_analysis_data) %>% 
  .[,map(.SD, ~ uniqueN(.x)),.SDcols = exam_table$LABNMABV] %>% 
  { names(.)[str_which(.,"1")] }
```
<br/>

# Feature selection
## Kaiser–Meyer–Olkin (KMO) test for the measure of adequacy (MSA)
```{r Feature selection by KMO test, warning = FALSE}
MSA_cutoff  <- 0.6
MSAi_cutoff <- 0.5
redundant_iter_vars <- redundant_vars

repeat {
  
  # Construct the correlation coefficient matrix (remove redundant variables in advance)
  cramerV_iter_dataset <- 
    if (length(redundant_iter_vars)>0) { 
      copy(cluster_analysis_data) %>% 
        .[,.SD,.SDcols = -(redundant_iter_vars)] %>% 
        cramerV_matrix(dataset = .,
                       vars = str_subset(exam_table$LABNMABV,
                                         paste(redundant_iter_vars,collapse = "|"),
                                         negate = TRUE)) %>% 
        setNames(.,
                 str_subset(exam_table$LABNMABV,
                            paste(redundant_iter_vars,collapse = "|"),
                            negate = TRUE))
      } else { 
        
        cluster_analysis_data[,.SD] %>% 
        cramerV_matrix(dataset = .,
                       vars = exam_table$LABNMABV) %>% 
        setNames(.,exam_table$LABNMABV)
        
      }
  
  # Prepare the correlation coefficient matrix for the KMO test
  mod_cramerV_iter_dataset <- 
    copy(cramerV_iter_dataset) %>% 
    as.data.table(.,keep.rownames = "ITEM") %>% 
    melt.data.table(.,id.vars = "ITEM",variable.name = "ITEM_2") %>% 
    .[,ITEM := factor(ITEM,levels = levels(ITEM_2))] %>% 
    dcast.data.table(.,... ~ ITEM_2,value.var = "value") %>% 
    as.matrix(.,rownames = "ITEM")
  
  # KMO test 
  KMO_iter_results  <- KMO(mod_cramerV_iter_dataset)
  
  # iterate till overall MSA is over the specified cutoff value
  if (KMO_iter_results$MSA>=MSA_cutoff) break
  
  # Find the variable with the smallest MSAi value to remove
  min_MSAi_var <- KMO_iter_results$MSAi[KMO_iter_results$MSAi <= MSAi_cutoff] %>% 
                  which.min(.) %>% 
                  names(.)
  
  redundant_iter_vars <- append(redundant_iter_vars,min_MSAi_var)

}

print(KMO_iter_results)
```
<br/>

## Check whether the correlation matrix is an identity matrix by Bartlett’s test of Sphericity
```{r Bartlett’s test of Sphericity, warning=FALSE}
Bart_results <- 
  cortest.bartlett(mod_cramerV_iter_dataset,
                   # n = sqrt(nrow(cluster_analysis_data)))
                   n = nrow(cluster_analysis_data)/100)

print(Bart_results$p.value)
```
<br/>

# Data preparation for cluster analysis
## Specify variables to be removed
```{r Variables to be removed}
removed_variables <- 
  # remove variables with single unique value (all results are Normal)
  copy(cluster_analysis_data) %>% 
  .[,map(.SD, ~ n_distinct(.x)),.SDcols = exam_table$LABNMABV] %>% 
  { names(.)[str_which(.,"1")] } %>% 
  
  # remove variables not passing the KMO test for sampling of adequacy
  c(.,setdiff(exam_table$LABNMABV,names(KMO_iter_results$MSAi))) %>% 
  unique(.) %>%
  # modify variable names that have been changed due to previous steps
  str_replace_all(.,"\\.","\\-") %>% 
  str_replace_all(.,c("DC-IgG" = "DC IgG","FLC-Kappa" = "FLC Kappa","CH50-Assay" = "CH50 Assay"))

```
<br/>

## Remove the specified variables from the data set for cluster analysis 
```{r Prepare the dataset for cluster analysis}
cluster_analysis_ready_data <-  
  copy(cluster_analysis_data) %>% 
  .[,.SD,.SDcols = -c(removed_variables)] %>% 
  .[,.SD,.SDcols = -c("IDCODE","Group","AGE","SEX")]
```
<br/>

# Cluster analysis
## MCA k-means
```{r Cluster analsyis using MCA k-means, warning=FALSE, message=FALSE, results = 'hide', cache=TRUE}
plan(multisession, workers = 6)

alphak_vector <- 0.5
seed_vector   <- 365 # for MAC OS: 365; on Linux OS, use 20211111 instead.
result_list_name <- paste("seed =",seed_vector)

monoCTD_MCAkmeans_tune <-
  future_map(seed_vector,
             ~ tuneclus(data = cluster_analysis_ready_data,
                        nclusrange = 3:6,
                        ndimrange = 2:4,
                        criterion = "asw",
                        method = "MCAK",
                        alphak = alphak_vector,
                        seed = .x)
             ) %>% 
  setNames(.,
           result_list_name)

plan(sequential)

```
<br/>

```{r echo=FALSE, results='hide'}
map(result_list_name,
    ~ pluck(monoCTD_MCAkmeans_tune,.x) %>%
      pluck(.,"clusobjbest"))

```

***

# Data profile for demographic and immunomarker variables
## Prepare clustering result datasets to extract data for the profile
```{r Prepare clustering result datasets}
PC_data <-
  # Retrieve the best result object
  pluck(monoCTD_MCAkmeans_tune,result_list_name[1]) %>% 
  pluck(.,"clusobjbest") %>% 
  # Retrieve PC coordinate and cluster data
  { cbind(pluck(.,"obscoord"),
          pluck(.,"cluster") ) } %>% 
  as.data.table(.) %>% 
  # Set names
  { setnames(.,c(paste("PC",seq(1,ncol(.)-1),sep = " "),"Cluster")) } %>% 
  # Add Group column
  cbind(.,
        cluster_analysis_data) %>% 
  # Factorise Cluster column
  .[,':=' (Cluster = factor(Cluster,
                            levels = seq(min(Cluster),max(Cluster),by = 1)),
           Group   = factor(Group,
                            levels = selected_disease_groups))]


attr_data <- 
  # Retrieve best result object
  pluck(monoCTD_MCAkmeans_tune,result_list_name[1]) %>% 
  pluck(.,"clusobjbest") %>% 
  # Retrieve attribute data
  pluck(.,"attcoord") %>% 
  as.data.table(.,keep.rownames = TRUE) %>% 
  { setnames(.,c("Attr",paste("PC",seq(1,ncol(.)-1),sep = " "))) } %>% 
  # Modify values in the attribute column and create the status column for plotting purposes
  .[,Attr_mdf := str_sub(Attr,
                         str_locate(Attr,"\\.AbN|\\.N")[,"start"]) %>% 
                 str_replace(.,"\\.","")] %>% 
  .[,Status   := str_split(Attr_mdf,"_",simplify = TRUE)[,1] %>% 
                 factor(.,levels = c("N","AbN"))]

```
<br/>

```{r echo=FALSE, message=FALSE, results='hide'}
saveRDS(PC_data,"./Dataset/PC_data.rds")
saveRDS(attr_data,"./Dataset/attr_data.rds")

```

## Data preprocess 
```{r Tabulate for the profile}
auto_antibody_string <- unique(sapply(str_split(attr_data$Attr_mdf,"_"),`[`,2))

table_one_by_diseases <- 
  # data preps
  copy(PC_data) %>% 
  { .[,.SD,.SDcols = -c(str_subset(names(.),"^PC|^Cluster"))] } %>% 
  .[,SEX := factor(SEX,levels = c("M","F"),labels = c("Male","Female"))] %>% 
  .[,c(auto_antibody_string) := map(.SD, ~ sapply(str_split(.x,"_"),`[`,1)),.SDcols = auto_antibody_string] %>% 
  .[,c(auto_antibody_string) := map(.SD, ~ factor(.x,levels = c("N","AbN"))),.SDcols = auto_antibody_string] %>% 
  # create the table one
  CreateTableOne(data = .,
                 strata = "Group",
                 vars = c("AGE","SEX",auto_antibody_string),
                 factorVars = c("SEX",auto_antibody_string),
                 test = TRUE,
                 testExact = TRUE,
                 smd = FALSE,
                 addOverall = FALSE)

# p values calculation
p_value_table <- 
  map(list(table_one_by_diseases$ContTable,
           table_one_by_diseases$CatTable) %>% 
      compact(.),
      ~ attr(.x,"pValues") %>% 
        as.data.table(.,keep.rownames = TRUE) %>% 
        .[,-3] %>% 
        setnames(.,c("Variable","p value")) %>% 
        .[,"p value" := ifelse(`p value`<0.001,"<0.001",sprintf("%.3f",`p value`))]) %>% 
    rbindlist(.)

# statistics calculations for continuous variables by SAD group
table_one_continuous_var <- 
  # extract desired statistics and merge them into one data.table by SAD group
  map(table_one_by_diseases$ContTable,
      ~ .x[,c("n","mean","sd")] %>% 
        as.data.table(x = .,keep.rownames = "Statistics") %>% 
        setnames(.,".","value")) %>% 
    rbindlist(.,use.names = TRUE,idcol = "Group") %>% 
  # retrieve data and modify values for an easy-to-read purpose
  dcast.data.table(., ... ~ Statistics,value.var = "value") %>% 
  .[,':=' (n    = comma(n),
           mean = sprintf("%.1f",mean),
            sd   = sprintf("%.1f",sd))] %>% 
  .[,"mean (sd)" := paste0(sprintf("%3s ",mean),"(",sprintf("%4s",sd),")")] %>% 
  # transform dataset for the tabulation purpose
   melt.data.table(.,id.vars = "Group",variable.name = "Statistics",value.name = "value") %>% 
   dcast.data.table(., ... ~ Group,value.var = "value") %>% 
  .[Statistics %in% "mean (sd)",] %>% 
  .[,':=' (Ori_Variable = "AGE",
           Variable     = "Age")] %>% 
  merge(.,
        p_value_table,
        by.x = "Ori_Variable",
        by.y = "Variable")
  

# statistics calculations for categorical variables by SAD group
table_one_categorical_var <- 
  # extract desired statistics and merge them into one data.table by SAD group
  map(table_one_by_diseases$CatTable,
      ~ map(.x, ~ .x[,c("level","freq","percent")]) %>% 
        rbindlist(.,idcol = "Ori_Variable")
      ) %>% 
  rbindlist(.,idcol = "Group") %>% 
  # retrieve data and modify values for an easy-to-read purpose
  .[!level %in% "N",] %>% 
  .[,':=' (freq    = as.integer(freq) %>% comma(.,accuracy = 1),
           percent = sprintf("%.2f",percent) %>% str_replace_all(.,"0.00","0"))] %>% 
  .[,"n (%)" := sprintf("%3s (%s)",freq,percent)] %>% 
  .[Ori_Variable=="SEX",Variable := level] %>% 
  .[is.na(Variable), Variable := Ori_Variable] %>% 
  # transform dataset for the tabulation purpose
  .[,.SD,.SDcols = -c("level")] %>% 
  dcast.data.table(.,Variable + Ori_Variable ~ Group, drop = TRUE,value.var = "n (%)") %>% 
  .[,"Statistics" := "n (%)"] %>% 
  merge(.,
        p_value_table,
        by.x = "Ori_Variable",
        by.y = "Variable")
```
<br/>

## Generate a table for the data profile[^1]
```{r Generate a table of the data profile}
# Create customised column title
table_lable <- 
  map(table_one_by_diseases$ContTable,
      ~ .x[,1] %>% as.data.table) %>% 
  rbindlist(.,idcol = "Group") %>% 
  setnames(.,c("Group","n")) %>% 
  .[,table_lable := paste0(Group,"\n","(n = ",comma(n),")") %>% 
                    str_replace_all(.,"Sjogren's syndrome","Sjogren's\nsyndrome") %>% 
                    str_replace_all(.,"Rheumatoid arthritis","Rheumatoid\narthritis") %>% 
                    str_replace_all(.,"Systemic lupus erythematosus","Systemic lupus\nerythematosus")] %>% 
  .[,table_lable]


# For substituting immunomarker abbreviations with complete names
var_short_names <- str_subset(table_one_categorical_var$Variable,paste(exam_table$LABNMABV,collapse = "|"))
var_long_names  <- exam_table[order(LABNMABV),][LABNMABV %in% var_short_names,ITEM]

# Table one template
table_one_template <- 
  map(list(table_one_continuous_var,
           table_one_categorical_var),
      ~ .x[is.na(Variable),Variable := Ori_Variable] %>% 
        .[,.SD,.SDcols = -c("Ori_Variable")]) %>% 
  rbindlist(.,use.names = TRUE) %>% 
  # Variable group assigning
    .[Variable %in% c("Age"),':=' (Variable = paste("Age",Statistics,sep = ", "),
                                   Group    = NA_character_)] %>% 
    .[Variable %in% c("Male","Female"),Group := paste("Sex",Statistics,sep = ", ")] %>% 
    .[Variable %in% c("C3","C4"), Group := paste("Complement(= abnormal)",Statistics,sep = ", ")] %>% 
    .[str_detect(Variable,"Age|Male|Female|C3|C4",negate = TRUE), Group := paste("Auto-antibodies(= positive)",Statistics,sep = ", ")] %>% 
    .[,Group := factor(Group,levels = c(NA_character_,
                                        "Sex, n (%)",
                                        "Auto-antibodies(= positive), n (%)",
                                        "Complement(= abnormal), n (%)"),
                       exclude = NULL)] %>% 
  # Substitute immunomarker abbreviations with complete descriptions
    setkey(Variable) %>% 
    .[var_short_names,Variable := var_long_names] %>% 
  # For an easy-to-read purpose
    .[str_detect(Variable,"Age",negate = TRUE),Variable := sprintf("\t%s",Variable)] %>% 
    .[,.SD,.SDcols = -c("Statistics")] %>% 
    setcolorder(.,c("Group","Variable",names(table_one_by_diseases$CatTable))) %>% 
    .[order(Group,na.last = FALSE),] %>% 
  as_grouped_data(., groups = "Group",columns = NULL) %>% 
  setnames(.,c(names(table_one_by_diseases$CatTable)),table_lable)


# Set output formats
set_flextable_defaults(font.family = "Calibri",
                       font.size = 10)

# Table one generation
table_one_flextable <- 
  flextable(table_one_template,
            col_keys = c("Variable",table_lable,"p value"),
            cwidth =c(1.45,1,1,1),
            theme_fun = 
            ) %>% 
    compose(.,
            i = ~!is.na(Group),
            j = "Variable",
            value = as_paragraph(as_chunk(Group))) %>% 
    align(.,j = c(table_lable,"p value"),align = "right",part = "all") %>% 
  autofit(.)

```
<br/>

[^1]: Please refer to the manuscript for **Table 1**

```{r Save the table, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
if(!dir.exists("./Cluster_Analysis_files/")) {
   dir.create("./Cluster_Analysis_files/",recursive = TRUE)
}

save_as_image(table_one_flextable,
              path = "./Cluster_Analysis_files/Table_of_distribution_of_variables.png",
              expand = 20,
              zoom = 4,
              webshot = "webshot")

# system(
#   paste0("cp \\",
# 
#          "./Cluster_Analysis_files/",
#          "Table_of_distribution_of_variables",
#          ".png",
#          " \\",
#          "./Files_for_Publication/",
#          "Table1_distribution_of_variables",
#          ".png"
#          )
#   )
```

***

# Presentation for clustering results
## Biplot of the first and second principal components
```{r Biplot by principal components, warning=FALSE, message=FALSE}
variable_list <- 
  map(c(sum(str_detect(names(PC_data),"^PC")):2),
      ~ paste0("`","PC ",c(.x-1,.x),"`") %>% 
        c(.,"Status","Attr_mdf","Cluster","Group")) %>% 
  rev(.)

cluster_color_set <- 
  c(pal_nejm(alpha = 0.8)(n_distinct(PC_data$Cluster))[-6],"grey10")

cluster_biplots <- 
  map(variable_list,
      ~ ggplot() +
          geom_point(data = PC_data[,unique(.SD),.SDcols = -c("IDCODE","SEX","AGE")],
                     aes_string(x = .x[1],y = .x[2],color = .x[5],shape = .x[6]),
                     position = position_jitter(height = 0.001,width = 0.001),
                     size = 1.5,
                     alpha = 0.5) +
          geom_point(data = attr_data[Status %in% c("AbN"),],
                     aes_string(x = .x[1],y = .x[2]),
                     size = 2,
                     shape = "cross",
                     color = "black",
                     alpha = 0.3) +
          geom_text_repel(data = attr_data[Status %in% c("AbN"),] %>% 
                                 .[,Attr_mdf := str_replace_all(Attr_mdf,"AbN_","")],
                          aes_string(x = .x[1],y = .x[2],label = .x[4]),
                          size = rel(3),
                          alpha = 0.2,
                          min.segment.length = 5,
                          box.padding = .3,
                          max.overlaps = 10) +
          geom_vline(xintercept = 0,color = "black",alpha = 0.4) +
          geom_hline(yintercept = 0,color = "black",alpha = 0.4) +
          geom_mark_ellipse(data = PC_data[,unique(.SD),.SDcols = -c("IDCODE","SEX","AGE")],
                            aes_string(x = .x[1],y = .x[2],fill = .x[5]),color = NA,
                            alpha = 0.2) +
          scale_linetype_discrete(name = "Immunomaker Test Results") +
          scale_shape_discrete(name = "SAD",labels = map_chr(selected_disease_groups,
                                                              ~ str_split(.x,"\\ ") %>%
                                                                map_chr(.,~ str_sub(.x,1,1) %>% toupper(.) %>% str_flatten(.)))) +
          scale_colour_manual(name = "Cluster",values = cluster_color_set) +
          scale_fill_manual(name = "Cluster",values = cluster_color_set) +
          scale_x_continuous(name = str_replace_all(.x[1],"\\`","")) +
          scale_y_continuous(name = str_replace_all(.x[2],"\\`","")) +
          guides(shape = guide_legend(override.aes = list(size = 2.5)),
                 color = guide_legend(override.aes = list(size = 2.5),nrow = 1)) +
          theme_bw() +
          theme(axis.title.x    = element_text(face = "bold",size = rel(1),margin = margin(.5,0,0,0,"cm")),
                axis.title.y    = element_text(face = "bold",size = rel(1),margin = margin(0,.5,0,0,"cm")),
                axis.text       = element_text(face = "bold",size = rel(.9)),
                legend.title    = element_text(face = "bold",size = rel(1)),
                legend.text     = element_text(size = rel(.9)),
                legend.position = "bottom",
                legend.box.margin = margin(0,2,0,0,"cm"))
      )
```
<br/>

```{r biplot by principal components - file generating, echo=FALSE}
if(!dir.exists("./Cluster_Analysis_files/PC_biplot")) {
   dir.create("./Cluster_Analysis_files/PC_biplot",recursive = TRUE)
  }

walk2(cluster_biplots,
      map(variable_list,~ paste0(str_replace_all(.x[1],"\\`|\\s",""),
                                 "_",
                                 str_replace_all(.x[2],"\\`|\\s",""),
                                 "_result_biplot")),
      ~ ggsave(filename = paste0("./Cluster_Analysis_files/PC_biplot/",
                                 .y,
                                 ".jpeg"),
               plot = .x,
               device = "jpeg",
               width = 10,height = 6,dpi = 600,
               units = "in")
      )

```
<br/>

## Profile the number and proportion of cases in each cluster
```{r Number and proportion of case in each cluster}
cluster_size_string <- 
  copy(PC_data) %>% 
  .[,.N,by = "Cluster"] %>% 
  .[,strings := label_comma()(N)] %>% 
  .[order(Cluster),]

profile_by_cluster_data <- 
  copy(PC_data) %>% 
    .[,.N,by = c("Cluster","Group")] %>% 
    .[order(Cluster,Group),] %>%
    .[,Cluster_label := factor(Cluster,
                               levels = cluster_size_string$Cluster,
                               labels = cluster_size_string$strings)] %>% 
    .[,Cluster_size       := sum(N),by = c("Cluster")] %>% 
    .[,Cluster_proportion := sqrt(round(Cluster_size/sum(N),3))*0.95] %>% 
    .[,Group_proportion   := round(N/Cluster_size,3)] %>% 
    .[,Group_position   := cumsum(Group_proportion)-0.5*Group_proportion,by = c("Cluster")] %>% 
    .[,Group := factor(Group,
                       levels = selected_disease_groups,
                       labels = map_chr(selected_disease_groups,~ str_split(.x,"\\s") %>% 
                                                                  map_chr(., ~ str_sub(.x,1,1) %>% 
                                                                  str_to_upper(.) %>% 
                                                                  str_c(.,collapse = ""))))]

profile_by_cluster_holistic_data <- 
  merge(profile_by_cluster_data,
        { copy(profile_by_cluster_data) %>% 
          .[,unique(.SD),.SDcols = c("Cluster","Cluster_proportion")] %>% 
          .[,x_position := round(cumsum(Cluster_proportion/sum(Cluster_proportion))-2.2*Cluster_proportion/sum(Cluster_proportion),3)] %>%
          .[,.SD,.SDcols = -c("Cluster_proportion")] },
        by = "Cluster",
        all.x = TRUE
  ) %>% 
  .[,Cluster_label := factor(Cluster,
                             levels = sort(unique(cluster_size_string$Cluster)),
                             labels = cluster_size_string$strings)]


profile_by_cluster_integrated <- 
  ggplot(profile_by_cluster_holistic_data,aes(width = Cluster_proportion)) +
      geom_bar(aes(x = x_position,y = Group_proportion,fill = Group),
               stat = "identity",position = "stack",alpha = 0.8) +
      scale_x_continuous(name = "Cluster\n(n)",
                         breaks = unique(profile_by_cluster_holistic_data$x_position),
                         labels = unique(profile_by_cluster_holistic_data$Cluster),
                         expand = c(0.001,0.001)) +
      scale_y_continuous(name = "Percentage",
                         breaks = seq(0,1,by = 0.2),
                         labels = seq(0,100,by = 20),
                         expand = c(0,0),) +
      scale_fill_manual(name = "SAD",values = pal_jama()(3)) +
      facet_grid(~ Cluster_label, space = "free_x", scales = "free_x",switch = "x") +
      theme_bw() +
      theme(legend.title = element_text(face = "bold",size = rel(1)),
            legend.text = element_text(face = "bold",size = rel(.9)),
            legend.position = "bottom",
            legend.key.size = unit(.8,"line"),
            axis.title.x = element_text(face = "bold",size = rel(1),margin = margin(.3,0,0,0,unit = "cm")),
            axis.title.y = element_text(face = "bold",size = rel(1),margin = margin(0,.3,0,0,unit = "cm")),
            axis.text = element_text(face = "bold",size = rel(.9)),
            strip.placement = "outside",
            strip.background = element_blank(),
            strip.text = element_text(face = "bold",size = rel(.6),vjust = 3.5),
            panel.border = element_blank()
            )

```
<br/>

```{r Number and proportion of case in each cluster - file generating, echo=FALSE}
if(!dir.exists("./Cluster_Analysis_files/Cluster_profile")) {
   dir.create("./Cluster_Analysis_files/Cluster_profile", recursive = TRUE)
  }

ggsave(filename = paste0("./Cluster_Analysis_files/Cluster_profile/",
                         "profile_by_cluster_integrated",
                         ".jpeg"),
       plot = profile_by_cluster_integrated,
       device = "jpeg",
       width = 7,height = 4,dpi = 600,
       units = "in")

```
<br/>

## Profile the number and proportion of case in each SAD group
```{r Number and proportion of case in each SAD group}
cluster_size_string <- 
  copy(PC_data) %>% 
  .[,.N,by = "Group"] %>% 
  .[order(-N),] %>% 
  .[,Group_abr := factor(Group,
                         levels = unique(Group),
                         labels = map_chr(Group,~ str_split(.x,"\\s") %>% 
                                                  map_chr(., ~ str_sub(.x,1,1) %>% 
                                                               str_to_upper(.) %>% 
                                                               str_c(.,collapse = ""))))] %>% 
  .[,strings := label_comma()(N)]

profile_by_group_data <- 
  copy(PC_data) %>% 
    .[,.N,by = c("Cluster","Group")] %>% 
    .[order(Group,-Cluster),] %>% 
    .[,Group_label := factor(Group,
                             levels = cluster_size_string$Group,
                             labels = cluster_size_string$strings)] %>%
    .[,Group_size := sum(N),by = "Group"] %>% 
    .[,Cluster_proportion_within_group := round(N/Group_size,4)] %>% 
    .[,Cluster_proportion_within_group_position := cumsum(Cluster_proportion_within_group)-0.5*Cluster_proportion_within_group,by = c("Group")] %>% 
    .[,Group := factor(Group,
                       levels = cluster_size_string$Group,
                       labels = cluster_size_string$Group_abr)]

profile_by_group_holistic_data <- 
  merge(profile_by_group_data,
        { copy(profile_by_group_data) %>% 
          .[,unique(.SD),.SDcols = c("Group","Group_size")] %>% 
          .[,Group_proportion := round(Group_size/sum(Group_size),3),] %>% 
          .[,x_position := round(cumsum(Group_proportion/sum(Group_proportion))-0.5*Group_proportion/sum(Group_proportion),3)] %>% 
          .[,.SD,.SDcols = -c("Group_size")] },
        by = "Group",
        all.x = TRUE
  )

profile_by_group_integrated <- 
  ggplot(profile_by_group_holistic_data,aes(width = Group_proportion)) +
      geom_bar(aes(x = x_position,y = Cluster_proportion_within_group,fill = Cluster),
               stat = "identity",position = "stack",alpha = 0.7) +
      scale_x_continuous(name = "SAD\n(n)",
                         breaks = unique(profile_by_group_holistic_data$x_position),
                         labels = unique(profile_by_group_holistic_data$Group),
                         expand = c(0.001,0.001)) +
      scale_y_continuous(name = "Percentage",
                         breaks = seq(0,1,by = 0.2),
                         labels = seq(0,100,by = 20),
                         expand = c(0,0)) +
      scale_fill_manual(values = cluster_color_set) +
      facet_grid(~ Group_label, space = "free_x", scales = "free_x",switch = "x") +
      theme_bw() +
      theme(legend.title = element_text(face = "bold",size = rel(1)),
            legend.text = element_text(face = "bold",size = rel(.9)),
            legend.position = "bottom",
            legend.key.size = unit(.6,"line"),
            axis.title.y = element_text(face = "bold",size = rel(1),margin = margin(0,.3,0,0,unit = "cm")),
            axis.title.x = element_text(face = "bold",size = rel(1),margin = margin(0,0,0,0,unit = "cm")),
            axis.text = element_text(face = "bold",size = rel(.9)),
            strip.placement = "outside",
            strip.background = element_blank(),
            strip.text = element_text(face = "bold",size = rel(.6),vjust = 3.5),
            panel.border = element_blank()
            ) +
      guides(fill = guide_legend(nrow=1,byrow=TRUE))

```
<br/>


```{r Number and proportion of case in each group - file generating, echo=FALSE} 
ggsave(filename = paste0("./Cluster_Analysis_files/Cluster_profile/",
                         "profile_by_group_integrated",
                         ".jpeg"),
       plot = profile_by_group_integrated,
       device = "jpeg",
       width = 10,height = 4,dpi = 600,
       units = "in")

```

## Combine the plots to present in a single frame - Figure 2[^2]
```{r Combine the plots to present in a single frame - Figure 2, message=FALSE, results='hide', warning=FALSE}
concatenated_clustering_results_plot <- 
  ggarrange(cluster_biplots[[1]],
            ggarrange(profile_by_cluster_integrated,
                      profile_by_group_integrated,
                      nrow = 2,labels = c("B","C")),
            ncol = 2,
            labels = c("A"),
            widths = c(1.5,1))


ggexport(concatenated_clustering_results_plot,
         filename = paste0("./Cluster_Analysis_files/Cluster_profile/",
                           "clustering_results_and_cluster_content_profile",
                           ".jpeg"),
         width = 12000,height = 8000,res = 1000,verbose = FALSE)

# system(
#   paste0("cp \\",
#          
#          "./Cluster_Analysis_files/Cluster_profile/",
#          "clustering_results_and_cluster_content_profile",
#          ".jpeg",
#          " \\",
#          "./Files_for_Publication/",
#          "Figure2_clustering_results_and_cluster_content_profile",
#          ".jpeg"
#          )
#   )
```
[^2]: Please refer to the manuscript for **Figure 2**

# Immunomarker profile among clusters
## Profile the proportion of status in each immunomarker by cluster
```{r Proportion of status in each immunomarker by cluster}
exam_items <- attr_data[,str_replace_all(Attr_mdf,"AbN_|N_","") %>% unique(.)]

profile_status_by_item_data <- 
  copy(PC_data) %>% 
  # Subset data by column names
  .[,.SD,.SDcols = c("IDCODE","Cluster","Group",exam_items)] %>% 
  # Transform data set into long format for further data portraying
  melt(.,
       measure.vars = exam_items,
       variable.name = "Exam_item",
       value.name = "Status") %>%
  # Modify results values by removing Exam_item strings in values
  .[,Status := str_replace_all(Status,
                               paste(c("_",exam_items),collapse = "|"),
                               "")] %>%
  # Tabulation
  .[,.N,by = c("Cluster","Exam_item","Status")] %>%
  # Transform data set for tabulating every possible permutation
  dcast.data.table(.,... ~ Status,value.var = "N",fill = 0) %>% 
  melt.data.table(.,id.vars = c("Cluster","Exam_item"),variable.name = "Status",value.name = "N") %>% 
  # Calculation for proportions
  .[,proportion := round(N/sum(N),3),by = c("Cluster","Exam_item")] %>%
  # Subset data set for those rows of Abnormal Status
  .[Status %in% "AbN",] %>%
  # Data ordering
  .[order(Cluster,-proportion),]

```
<br/>

## Prepare plot data for immunomarker profile
```{r plot data for immunomarker profile, warning=FALSE, message=FALSE}
radar_plot_item_order <- 
  split(profile_status_by_item_data,by = "Cluster") %>% 
  map(., ~ .x[order(-proportion),] %>%
           .[proportion > 0.5,as.character(Exam_item)] ) %>%
  flatten_chr(.) %>% 
  unique(.) %>% 
  # set the above variables in the front of other variables
  { c(.,str_subset(levels(profile_status_by_item_data$Exam_item),
                   paste(.,collapse = "|"),
                   negate = TRUE)) } %>% 
  str_subset(.,
             split(profile_status_by_item_data,by = "Exam_item") %>% 
              # remove exam items in all clusters are less than 10%
              map(., ~ .x[all(proportion<=0.1),unique(as.character(Exam_item))]) %>% 
              flatten_chr(.) %>% 
              paste(.,collapse = "|"),
             negate = TRUE)

customised_rose_plot_item_order <-
  c("ANA", "C3", "C4", "Anti-dsDNA",
    "CRYOID", "ACAG", "Anti-RNP-Sm", "Anti-SSB", "Anti-SSA", "RF")

profile_status_by_item_plot_data <-  
  copy(profile_status_by_item_data) %>% 
  .[,.SD,.SDcols = c("Cluster","Exam_item","proportion")] %>% 
  .[Exam_item %in% customised_rose_plot_item_order,] %>% 
  .[,Exam_item := factor(Exam_item,levels = customised_rose_plot_item_order)] %>%
  .[,Cluster := factor(Cluster,
                       levels = levels(Cluster),
                       labels = map_chr(levels(Cluster),
                                        ~ str_c("Cluster ",.x)))] %>% 
    .[order(Cluster,Exam_item),] %>% 
  dcast.data.table(.,... ~ Exam_item,value.var = "proportion")

```
<br/>

## Profile immunomarker status by cluster - overlapped
```{r Immunomarker status by cluster - overlapped, warning=FALSE, message=FALSE}
# A function for change the colour transparency of a given colour set
t_col <- 
  function(color, percent = percent, name = NULL) {
    ## Get RGB values for named colour
    rgb.val <- col2rgb(color)
  
    ## Make new colour using input colour as base and alpha set by transparency
    t.col <- rgb(rgb.val[1], rgb.val[2], rgb.val[3],
                 max = 255,
                 alpha = (100 - percent) * 255 / 100,
                 names = name)
    
    ## Save the colour
    invisible(t.col)
}

profile_status_by_item_overlapped_plot <-
  ggRadar2(data = profile_status_by_item_plot_data,
           aes(group = Cluster),
           alpha = 0.05,
           size = .1,
           rescale = FALSE) +
    scale_color_manual(values = map_chr(cluster_color_set, ~ t_col(.x,percent = 40)),
                       labels = c(profile_status_by_item_plot_data[,str_replace_all(Cluster,"Cluster\\s","")])) +
    scale_fill_manual(values = map_chr(cluster_color_set, ~ t_col(.x,percent = 40)),
                      labels = c(profile_status_by_item_plot_data[,str_replace_all(Cluster,"Cluster\\s","")])) +
    scale_y_continuous(breaks = seq(0,1,by = .25),
                       labels = paste0(seq(0,100,by = 25),"%"),
                       limits = seq(0,1)) +
    theme_bw() +
    theme(panel.border = element_blank(),
          panel.background = element_rect(fill = "white"),
          panel.grid = element_line(size = 0.5,linetype = 2),
          legend.position = "bottom",
          legend.title = element_text(face = "bold",size = rel(1.2)),
          legend.text = element_text(face = "bold",size = rel(1.1)),
          axis.text.x = element_text(face = "bold",size = rel(1.1),margin = margin(10,0,0,0)),
          axis.text.y = element_text(face = "bold",size = rel(1.1),margin = margin(0,10,0,0)),
          axis.ticks.y.left = element_blank(),
          plot.background = element_rect(fill = "white", color = "white")) +
    guides(color = guide_legend(nrow = 1,byrow = TRUE))

```
<br/>

```{r Immunomarker profile by cluster overlapped - file generating, echo=FALSE}
ggsave(filename = paste0("./Cluster_Analysis_files/Cluster_profile/",
                         "profile_status_by_item_overlapped_plot",
                         ".jpeg"),
       plot = profile_status_by_item_overlapped_plot,
       device = "jpeg",
       width = 10,height = 8.2,dpi = 600,
       units = "in")

```
<br/>

## Profile immunomarker status by cluster - separated
```{r Immunomarker status by cluster - separated, warning=FALSE, message=FALSE}
profile_status_by_item_roseplot <-
  copy(profile_status_by_item_plot_data) %>% 
  melt.data.table(data = .,
                  id.vars = "Cluster",
                  variable.name = "Biomarker",
                  variable.factor = TRUE,
                  value.name = "Proportion") %>% 
  { ggplot(data = .) +
      geom_bar(aes(x = Biomarker, y = Proportion, fill = Cluster), stat = "identity", colour = "grey20", size = .3) +
      scale_fill_manual(values = map_chr(cluster_color_set, ~ t_col(.x,percent = 40))) +
      scale_y_continuous(breaks = seq(0,1,by = .25),
                         labels = paste0(seq(0,100,by = 25),"%"),
                         limits = seq(0,1)) +
      theme_bw() +
      coord_polar(theta = "x", start = -pi/45, clip = "off") +
      theme(panel.border = element_blank(),
            panel.background = element_rect(fill = "white"),
            panel.grid = element_line(size = 0.5,linetype = 2),
            # panel.spacing = unit(.2, "lines"),
            legend.position = "none",
            axis.title = element_blank(),
            axis.text.x = element_text(face = "bold",size = rel(1),margin = margin(10,0,0,0)),
            axis.text.y = element_text(face = "bold",size = rel(1),margin = margin(0,10,0,0)),
            axis.ticks.y.left = element_blank(),
            strip.text = element_text(face = "bold",size = rel(1.2)),
            strip.background = element_blank(),
            plot.background = element_rect(fill = "white", color = "white")) +
      facet_wrap(Cluster ~ .,nrow = 2)
      
  }

```
<br/>

```{r Immunomarker profile by cluster separated - file generating, echo=FALSE}
ggsave(filename = paste0("./Cluster_Analysis_files/Cluster_profile/",
                         "profile_status_by_item_roseplot",
                         ".jpeg"),
       plot = profile_status_by_item_roseplot,
       device = "jpeg",
       width = 10,height = 8.2,dpi = 600,
       units = "in")

```
<br/>

## Calculation of sensitivity and specificity for assigning to clusters
### Data preps
```{r Data preps for sensitivity and specificity calculation}
# --------------------------------------------------------------------------------------------------------------
sen_spe_data_prep <- 
  copy(PC_data) %>% 
  .[,c(exam_items) := map(.SD,
                          ~ str_split(.x,"_",simplify = TRUE)[,1] %>% 
                            factor(.,
                                   levels = c("N","AbN"),
                                   labels = c("0","1"))),
    .SDcols = exam_items]

# --------------------------------------------------------------------------------------------------------------
sen_spe_data <- 
  PC_data[,unique(Cluster) %>% seq_along(.)] %>% 
  map(.,
      ~ copy(sen_spe_data_prep) %>% 
        .[,Truth := ifelse(Cluster==.x,1,0) %>% factor(.,levels = c(0,1))] %>% 
        .[,.SD,.SDcols = c("Truth",exam_items)] %>% 
        melt.data.table(., id.vars = "Truth", variable.factor = FALSE, value.name = "Test" ,value.factor = TRUE)
      )

# --------------------------------------------------------------------------------------------------------------
sens_result_data <- 
  map(sen_spe_data,
      ~ copy(.x) %>% 
        .[,sens_vec(truth = Truth, estimate = Test, event_level = "second"), by = "variable"] %>% 
        .[,.metric := "sens"] %>% 
        setnames(.,"V1",".estimate")
      )

spec_result_data <- 
  map(sen_spe_data,
      ~ .x[,spec_vec(truth = Truth, estimate = Test, event_level = "second"), by = "variable"] %>% 
        .[,.metric := "spec"] %>% 
        setnames(.,"V1",".estimate")
      )

sens_spec_result_data <- 
  map2(sens_result_data,
       spec_result_data,
       ~ rbind(.x,.y) %>% 
         setDT(.) %>% 
         .[,.metric := factor(.metric, levels = c("spec","sens"), labels = c("Specificity","Sensitivity"))] %>% 
         .[, cumulative_estimate := cumsum(.estimate), by = c("variable")]
         # dcast.data.table(., variable ~ .metric, value.var = ".estimate") %>% 
         # .[, sum_sens_spec := rowSums(.SD), .SDcols = c("sens","spec")]
       ) %>% 
    setNames(.,paste(PC_data[,unique(Cluster) %>% seq_along(.)]) ) %>%
    rbindlist(.,idcol = "Cluster") %>% 
  .[variable %in% customised_rose_plot_item_order,] %>% 
  .[,variable := factor(variable,levels = rev(customised_rose_plot_item_order))] %>% 
  .[,Cluster := factor(Cluster,levels = PC_data[,levels(Cluster) %>% rev(.)])] %>%
  # melt.data.table(.,id.vars = c("Cluster","variable"), variable.name = "metric", value.name = "estimate") %>% 
  .[order(Cluster, .metric),]

```
<br/>

## Visualise the results
```{r sensitivity and specificity result visulisation, message=FALSE, warning=FALSE}
sens_spec_result_plot <- 
  copy(sens_spec_result_data) %>% 
  { ggplot(.,
           aes(x = variable, y = cumulative_estimate, fill = Cluster)) +
      geom_col(data = .[.metric=="Specificity"], width = .65, position = position_dodge(width = .7), alpha = .5) +
      geom_col(data = .[.metric=="Sensitivity"], width = .65, position = position_dodge(width = .7), alpha = 1) +
      geom_tile(aes(x = variable, y = NA_integer_, alpha = .metric)) +
      geom_hline(yintercept = 1,   size = .5, color = "grey40", linetype = 2) +
      geom_hline(yintercept = 1.5, size = .5, color = "grey20", linetype = 2) +
      scale_x_discrete(name = "Immunomarkers") +
      scale_alpha_discrete(name = "Metric", breaks = c("Sensitivity","Specificity")) +
      scale_y_continuous(name = "Sensitivity + Specificity",expand = c(0,0),limits = c(0,2)) +
      scale_fill_manual(values = rev(cluster_color_set)) +
      theme_bw()  +
      guides(fill = guide_legend(reverse = TRUE)) +
    theme(axis.title.x = element_text(face = "bold",size = rel(1.2),margin = margin(20,0,0,0)),
          axis.title.y = element_text(face = "bold",size = rel(1.2),margin = margin(0,20,0,0)),
          axis.text = element_text(face = "bold",size = rel(1)),
          legend.title = element_text(face = "bold",size = rel(1.2)),
          legend.text = element_text(face = "bold",size = rel(1))) +
    coord_flip() }
```
<br/>

```{r Sum of sensitivity and specificity result visulisation - file generating, echo=FALSE, warning=FALSE}
ggsave(filename = paste0("./Cluster_Analysis_files/Cluster_profile/",
                         "sens_spec_result_plot",
                         ".jpeg"),
       plot = sens_spec_result_plot,
       device = "jpeg",
       width = 10,height = 8.2,dpi = 600,
       units = "in")

```

## Combine the plots to present in a single frame - Figure 3[^3]
```{r Combine the plots to present in a single frame - Figure 3, message=FALSE, results='hide', warning=FALSE}
concatenated_immunomarkers_profile_plot <- 
  ggarrange(ggarrange(profile_status_by_item_roseplot,
                      profile_status_by_item_overlapped_plot,
                      nrow = 1, 
                      ncol = 2,
                      widths = c(3,2.05),
                      labels = c("A","B")),
            sens_spec_result_plot,
            labels = c("","C"),
            nrow = 2,
            ncol = 1)

ggexport(concatenated_immunomarkers_profile_plot,
         filename = paste0("./Cluster_Analysis_files/Cluster_profile/",
                           "immunomarker_profile",
                           ".jpeg"),
         width = 20000,height = 16000,res = 1200,verbose = FALSE)

# system(
#   paste0("cp \\",
#          
#          "./Cluster_Analysis_files/Cluster_profile/",
#          "immunomarker_profile",
#          ".jpeg",
#          " \\",
#          "./Files_for_Publication/",
#          "Figure3_immunomarker_profile_and_sen_spe",
#          ".jpeg"
#          )
#   )
```
<br/>

Next section:
[Clinical_Implication_Analysis.md](https://github.com/DHLab-TSENG/Heterogeneity-in-SAD-paper/blob/main/Clinical_Implication_Analysis.md)

[^3]: Please refer to the manuscript for **Figure 3**
